#!/bin/bash
# pre-commit - Enforce worktree-only development workflow
#
# Purpose: Block ALL commits in main directory. ALL work must be in worktrees.
# This includes source code, documentation, configuration - EVERYTHING.
#
# Enforcement Level: STRICT (Zero Exceptions)
# - Main directory should ONLY receive merges from worktrees
# - Direct commits are NEVER allowed, even for documentation
#
# Installation: Copy to .git/hooks/pre-commit and chmod +x
#
# Exit codes:
#   0 - In worktree (allowed to commit)
#   1 - In main directory (BLOCKED)

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function: Print colored message
log_error() { echo -e "${RED}[✗]${NC} $1" >&2; }
log_blocked() { echo -e "${RED}[BLOCKED]${NC} $1" >&2; }
log_info() { echo -e "${GREEN}[✓]${NC} $1"; }

# Get current directory and project info
CURRENT_DIR=$(pwd)
CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")

# Detect project root and name dynamically
PROJECT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || echo "")
PROJECT_NAME=$(basename "$PROJECT_ROOT")
PROJECT_PARENT=$(dirname "$PROJECT_ROOT")
WORKTREE_ROOT="${PROJECT_PARENT}/${PROJECT_NAME}-worktrees"

# Check if we're in a worktree by looking at the path
is_in_worktree() {
  # Method 1: Check if path contains -worktrees/
  if [[ "$CURRENT_DIR" == *"-worktrees/"* ]]; then
    return 0
  fi

  # Method 2: Check git worktree list
  if git rev-parse --git-dir 2>/dev/null | grep -q "worktrees"; then
    return 0
  fi

  return 1
}

# Check if we're in the main directory (not a worktree)
is_in_main() {
  # We're in main if:
  # 1. PROJECT_ROOT matches CURRENT_DIR (or CURRENT_DIR is under PROJECT_ROOT)
  # 2. AND we're NOT in a worktree

  if [[ "$CURRENT_DIR" == "$PROJECT_ROOT"* ]] && ! is_in_worktree; then
    return 0
  fi

  return 1
}

# Main check
if is_in_main; then
  log_blocked "======================================================="
  log_blocked "        PRE-COMMIT HOOK: WORKTREE ENFORCEMENT"
  log_blocked "======================================================="
  echo "" >&2
  log_error "Location: $CURRENT_DIR" >&2
  log_error "Branch: $CURRENT_BRANCH" >&2
  log_error "Project: $PROJECT_NAME" >&2
  echo "" >&2
  log_error "Direct commits to main directory are FORBIDDEN" >&2
  log_error "ALL work (code, docs, config) must be in worktrees" >&2
  echo "" >&2
  log_error "Staged files that would be committed:" >&2
  git diff --cached --name-only | sed 's/^/     /' >&2
  echo "" >&2
  log_error "Required workflow:" >&2
  log_error "  1. Create worktree for your work:" >&2
  log_error "     git worktree add ${WORKTREE_ROOT}/stream-XX-name -b stream-XX-name" >&2
  echo "" >&2
  log_error "  2. Navigate to worktree:" >&2
  log_error "     cd ${WORKTREE_ROOT}/stream-XX-name" >&2
  echo "" >&2
  log_error "  3. Make changes and commit in worktree" >&2
  echo "" >&2
  log_error "  4. Merge to main using the merge script:" >&2
  log_error "     ./.git-hooks/merge-worktree-to-main stream-XX-name" >&2
  echo "" >&2
  log_error "To move current changes to a worktree:" >&2
  log_error "   git stash" >&2
  log_error "   git worktree add ${WORKTREE_ROOT}/stream-XX-name -b stream-XX-name" >&2
  log_error "   cd ${WORKTREE_ROOT}/stream-XX-name" >&2
  log_error "   git stash pop" >&2
  echo "" >&2
  log_blocked "======================================================="

  exit 1
fi

# We're in a worktree - allow commit
log_info "Pre-commit check: PASSED (worktree location)"
exit 0
